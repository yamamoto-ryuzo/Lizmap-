[4.PostgreSQLデータベースの構築.md](https://github.com/yamamoto-ryuzo/Lizmap-installation-Japanese-memo/blob/main/4.PostgreSQL%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E6%A7%8B%E7%AF%89.md)  

#### 5-1.Lizmap Web Clientのインストール  
　シンボリックリンクを http://localhost/lizmap/ に設定する  
　現在のバージョンは 3liz/lizmap-web-client: Transfer a QGIS project on a server, Lizmap is providing the web interface to browse it (github.com) で確認。  

### step-1
##### (step1-VERSION=3.6.0) 
sudo su  
cd /var/www/  
VERSION=3.6.0  
#既存ディレクトリの強制削除  
#rm -rf /var/www/lizmap-web-client-$VERSION  
wget https://github.com/3liz/lizmap-web-client/releases/download/$VERSION/lizmap-web-client-$VERSION.zip  
#-o	ファイルを確認なしに上書きする  
unzip -o lizmap-web-client-$VERSION.zip  
rm /var/www/html/lizmap  
ln -s /var/www/lizmap-web-client-$VERSION/lizmap/www/ /var/www/html/lizmap  
rm lizmap-web-client-$VERSION.zip  
chown -R www-data:www-data /var/www/lizmap-web-client-$VERSION  

##### (step1-VERSION=3.5.6) 
sudo su  
cd /var/www/  
VERSION=3.5.6  
#既存ディレクトリの強制削除  
#rm -rf /var/www/lizmap-web-client-$VERSION  
wget https://github.com/3liz/lizmap-web-client/releases/download/$VERSION/lizmap-web-client-$VERSION.zip  
#-o	ファイルを確認なしに上書きする  
unzip -o lizmap-web-client-$VERSION.zip  
rm /var/www/html/lizmap  
ln -s /var/www/lizmap-web-client-$VERSION/lizmap/www/ /var/www/html/lizmap  
rm lizmap-web-client-$VERSION.zip  
chown -R www-data:www-data /var/www/lizmap-web-client-$VERSION  
  
### step-2
##### (step2)  
cd /var/www/lizmap-web-client-$VERSION/  
cd lizmap/var/config  
cp lizmapConfig.ini.php.dist lizmapConfig.ini.php  
cp localconfig.ini.php.dist localconfig.ini.php  
cp profiles.ini.php.dist profiles.ini.php  
cd ../../..  
#PHP スクリプトが一時ファイルを書き込んだり、変更を加えたりできるようにします。  
lizmap/install/set_rights.sh www-data www-data  
#インストールはpostgresの初期設定含む  
php lizmap/install/installer.php  


#### PostGIS等拡張機能のインストール  
[pgAdmin](https://www.pgadmin.org/)よりインストール 

sudo apt -y update  
sudo apt -y install postgis postgresql-14-postgis-3  

　ログインは　postgres：スーパーユーザーで行う必要あり  
　拡張　を　右クリック　＞　作成　＞　拡張　＞「postgis」を選択　＞保存  
　　　　　　　　　　　　　　　　　　　　　　＞「pg_trgm」を選択　＞保存  
  　　　　　　　　　　　　　　　　　　　　　＞「unaccent」を選択　＞保存  
「pg_trgm」「unaccent」はLizmapの検索機能で必要です。  

![image017](https://user-images.githubusercontent.com/86514652/174402540-0143fc31-e084-4edc-ae6b-be757b00ba1c.png)
  
### step-3
#####  (step3-初めてのインストール）
#ホームページMediaフォルダ参照のためのシンポリックリンク　の作成  
ln -s /var/www/lizmap/ /var/www/lizmap-web-client-$VERSION/lizmap/www/lizmap_symlink  

#Postgresqlデータベースにアクセスするためのいくつかのパラメータを指定  
#　/var/www/lizmap-web-client-$VERSION/lizmap/var/config/profiles.ini.php を編集  
#Webminより編集  
#　Tools　＞　FileManager　＞/var/www/lizmap-web-client-$VERSION/lizmap/var/config/profiles.ini.php  
#　下記項目を置き換え  

[jdb:jauth]  
driver=pgsql  
host=localhost  
port=5432  
database="lizmap"  
user=postgres  
password=***  
search_path=public  

[jdb:lizlog]  
driver=pgsql  
host=localhost  
port=5432  
database="lizmap"  
user=postgres  
password=***  
search_path=public

#####  (step3-アップデート）
#設定を引き継ぐバージョンを記入ください。  
old_VERSION=3.5.5  
    
#ホームページMediaフォルダ参照のためのシンポリックリンク　の作成  
ln -s /var/www/lizmap/ /var/www/lizmap-web-client-$VERSION/lizmap/www/lizmap_symlink  
  
#var/config/liveconfig.ini.php　は更新してはいけません。なぜなら，app/system/mainconfig.ini.php のパラメータを含んでおり、アプリケーション自体によって変更されるものです。  
  
cp -f /var/www/lizmap-web-client-$old_VERSION/lizmap/var/config/profiles.ini.php /var/www/lizmap-web-client-$VERSION/lizmap/var/config/profiles.ini.php  
cp -f /var/www/lizmap-web-client-$old_VERSION/lizmap/var/config/lizmapConfig.ini.php  /var/www/lizmap-web-client-$VERSION/lizmap/var/config/lizmapConfig.ini.php  
cp -f /var/www/lizmap-web-client-$old_VERSION/lizmap/var/config/localconfig.ini.php  /var/www/lizmap-web-client-$VERSION/lizmap/var/config/localconfig.ini.php  
  
#初期/Landingページのコンテンツ　のコピー  
cp -f -r /var/www/lizmap-web-client-$old_VERSION/lizmap/var/lizmap-theme-config/ /var/www/lizmap-web-client-$VERSION/lizmap/var/  

### step-4
##### (step4 lizmap-fcgi.conf　の修正)  
#/etc/apache2/conf-available/lizmap-fcgi.conf   
#バージョンアップごとに設定しないでもいい方法を今後検討！  
FcgidInitialEnv QGIS_PLUGINPATH /var/www/lizmap-web-client-3.5.5/lizmap/plugins  

[5-1-1インストールエラー](https://github.com/yamamoto-ryuzo/Lizmap-installation-Japanese-memo/blob/main/5.Lizmap%20Web%20Client%E3%81%AE%E8%A8%AD%E5%AE%9A/5-1-1%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%82%A8%E3%83%A9%E3%83%BC%E3%80%80Error%20in%20the%20main%20configuration.md)  
[5-2.Lizmap Web Clientの初期設定](https://github.com/yamamoto-ryuzo/Lizmap-installation-Japanese-memo/blob/main/5.Lizmap%20Web%20Client%E3%81%AE%E8%A8%AD%E5%AE%9A/5-2.Lizmap%20Web%20Client%E3%81%AE%E5%88%9D%E6%9C%9F%E8%A8%AD%E5%AE%9A.md)  
