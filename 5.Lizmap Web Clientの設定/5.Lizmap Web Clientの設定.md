### 5.Lizmap Web Clientの設定  
#### 5-1.Lizmap Web Clientのソースコードのインストールと設定  

・シンボリックリンクを http://localhost/lizmap/　に設定する  
・現在のバージョンは 3liz/lizmap-web-client: Transfer a QGIS project on a server, Lizmap is providing the web interface to browse it (github.com) で確認。  
2021/10/04　現在は　3.5.0  
(step1)  
sudo su  
cd /var/www/  
#unstalbe  
VERSION=3.5.1-pre  
wget https://packages.3liz.org/pub/lizmap/unstable/3.5/lizmap-web-client-3.5.1-pre.zip  
#VERSION=3.5.0  
#wget https://github.com/3liz/lizmap-web-client/releases/download/$VERSION/lizmap-web-client-$VERSION.zip  
unzip lizmap-web-client-$VERSION.zip  
rm /var/www/html/lizmap  
ln -s /var/www/lizmap-web-client-$VERSION/lizmap/www/ /var/www/html/lizmap  
rm lizmap-web-client-$VERSION.zip  
chown -R www-data:www-data /var/www/lizmap-web-client-$VERSION  

(step2)  
cd /var/www/lizmap-web-client-$VERSION/  
cd lizmap/var/config  
cp profiles.ini.php.dist profiles.ini.php  

(step4)  
・Postgresqlデータベースにアクセスするためのいくつかのパラメータを指定  
　/var/www/lizmap-web-client-$VERSION/lizmap/var/config/profiles.ini.php を編集  
Webminより編集  
　Tools　＞　FileManager　  
＞/var/www/lizmap-web-client-$VERSION/lizmap/var/config/profiles.ini.php  
　下記項目を置き換え  

[jdb:jauth]  
driver=pgsql  
host=localhost  
port=5432  
database="lizmap"  
user=postgres  
password=***  
search_path=public  

[jdb:lizlog]  
driver=pgsql  
host=localhost  
port=5432  
database="lizmap"  
user=postgres  
password=***  
search_path=public  

(step5)  
cd /var/www/lizmap-web-client-$VERSION/  
cd lizmap/var/config  
cp lizmapConfig.ini.php.dist lizmapConfig.ini.php  
cp localconfig.ini.php.dist localconfig.ini.php  
cd ../../..  
#インストールはpostgresの初期設定含む  
php lizmap/install/installer.php  

#### 5-2.Lizmap Web Clientのadminパスワード変更  
http://lizmap.yamakun.net/lizmap/  
　 
  
接続　＞　ユーザー名，パスワード共に初期設定は「admin」  
 
![image018](https://user-images.githubusercontent.com/86514652/174402684-72d9f4d9-20f5-4cf1-b69c-146db9400c85.png)

管理　＞　ユーザー　＞　admin    表示　＞　パスワードを変更する　＞　保存  

 ![image019](https://user-images.githubusercontent.com/86514652/174402705-90fc60bb-b40f-4b1f-a859-f830117a8ed1.png)

#### 5-3.Lizmap Web Clientの高速化（PHPのマルチスレッド化）  
(STEP１)  
sudo su  
apt -y install php-fpm  

vi /etc/apache2/sites-available/default-ssl.conf  
#バージョンはその都度確認の事　今回は8.0でした。  
#<VirtualHost> - </VirtualHost> 内に追記  
    <FilesMatch \.php$>  
        SetHandler "proxy:unix:/var/run/php/php8.0-fpm.sock|fcgi://localhost/"  
    </FilesMatch>  

a2enmod proxy_fcgi setenvif  
a2enconf php8.0-fpm  
systemctl restart php8.0-fpm apache2  

echo '<?php phpinfo(); ?>' > /var/www/html/lizmap/info.php  

  
https://lizmap.yamakun.net/info.php  

Server API[FPM/FastCGI] と表示されていれば OK です  
 
![image020](https://user-images.githubusercontent.com/86514652/174402814-5867b2f5-8e5a-463c-b38f-25fb838882e4.png)

（STEP2）  
ｐｈｐ-ｆｐｍの設定を行う  
 ![image021](https://user-images.githubusercontent.com/86514652/174402885-9083ab6c-91d4-4709-a81d-6af770155398.png)

 
をみると，pool.d/*.confに設定しろとある！  

　ｗｗｗ.ｃｏｎｆを確認すると，アカウント設定他いい感じに設定されている。  
　標準の　pm = dynamic　となっていたので，そのまま，下記を適切に設定！  
pm.max_children = 814  
pm.start_servers = 8  
pm.min_spare_servers = 4  
pm.max_spare_servers = 8  
pm.max_requests = 300  
![image022](https://user-images.githubusercontent.com/86514652/174402940-3afe36f6-e6ce-4ff0-95aa-36586fdacbe5.png)


動作確認は　htop　において　php-fpm　が複数起動し，きちんと動作していればＯＫ！  

（参考）問題なのは　qgis_mapserv.fcgi　のようです。  
 
  ![image023](https://user-images.githubusercontent.com/86514652/174403013-7ce10ae9-5627-4107-a257-59860b04cbec.png)

 
#### 5-4.Lizmap Web Clientの高速化（QGIS Serverのマルチスレッド化）  
※QGISサーバーの設定　2. Apache2の設定（QGIS Server Plugin含む）に追加  
内容はレンダリングのマルチスレッド指定  

　・lizmap-fcgi.conf　へ追加　マルチスレッドを追加のみ  
　/etc/apache2/conf-available/lizmap-fcgi.conf   

#QGISのマルチスレッド化  
#並列レンダリングがアクティブ化されたときに使用するスレッドの数。  
#値が指定されている場合は、プロセッサ コアの数を使用します。‎-1  
FcgidInitialEnv QGIS_SERVER_MAX_THREADS 10  
#WMS GetMap 要求の並列レンダリングをアクティブにします。  
#デフォルトでは() は無効になっています。使用可能な値は次のとおりです。‎false  
#0‎または (大文字と小文字を区別しない)‎false  
#1‎または (大文字と小文字を区別しない)‎true  
FcgidInitialEnv QGIS_SERVER_PARALLEL_RENDERING 1  

結果は，下記の通りqgis_mapserv.fcgiがマルチスレッドで動くようになりました。  
![image024](https://user-images.githubusercontent.com/86514652/174403739-0e21bc57-cb01-4a43-9dc6-ba67b62637f9.png)

 
#### 5-5.Lizmap Web Clientの高速化（py-qgis-serverの導入）　・・・　動きません，調査中  
sudo su  
#不要なものを削除  
sudo apt autoremove  
#システムを最新に  
apt -y upgrade  
#pipのインストール  
apt update  
apt -y uninstall python3-pip  
apt -y install python3-pip  
pip install --upgrade pip  
#zmq  
pip uninstall -y pyzmq  
pip install --no-cache-dir pyzmq  

#libzmq  
apt -y install libzmq3-dev  
#apt -y install libzmq5  

#py-qgis-serverのインストール  
#再インストールの場合は一度アンインストール  
pip uninstall -y py-qgis-server  
pip install --no-cache-dir py-qgis-server  

(STEP2)  
　・lizmap-fcgi.conf　へ設定を追加  
　/etc/apache2/conf-available/lizmap-fcgi.conf   

	[services]  
#wmsServerURL="http://my.domain:<port>/ows/"  
wmsServerURL="http://lizmap.yamakun.net:8080/ows/"  
#Use relative path  
relativeWMSPath=true  

(STEP3)  
qgisserver  
