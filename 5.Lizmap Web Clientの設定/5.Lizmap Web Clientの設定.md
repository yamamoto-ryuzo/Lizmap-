5.Lizmap Web Clientの設定<br>
5-1.Lizmap Web Clientのソースコードのインストールと設定<br>

・シンボリックリンクを http://localhost/lizmap/　に設定する<br>
・現在のバージョンは 3liz/lizmap-web-client: Transfer a QGIS project on a server, Lizmap is providing the web interface to browse it (github.com) で確認。<br>
2021/10/04　現在は　3.5.0<br>
(step1)<br>
sudo su<br>
cd /var/www/<br>
#unstalbe<br>
VERSION=3.5.1-pre<br>
wget https://packages.3liz.org/pub/lizmap/unstable/3.5/lizmap-web-client-3.5.1-pre.zip<br>
#VERSION=3.5.0<br>
#wget https://github.com/3liz/lizmap-web-client/releases/download/$VERSION/lizmap-web-client-$VERSION.zip<br>
unzip lizmap-web-client-$VERSION.zip<br>
rm /var/www/html/lizmap<br>
ln -s /var/www/lizmap-web-client-$VERSION/lizmap/www/ /var/www/html/lizmap<br>
rm lizmap-web-client-$VERSION.zip<br>
chown -R www-data:www-data /var/www/lizmap-web-client-$VERSION<br>

(step2)<br>
cd /var/www/lizmap-web-client-$VERSION/<br>
cd lizmap/var/config<br>
cp profiles.ini.php.dist profiles.ini.php<br>

(step4)<br>
・Postgresqlデータベースにアクセスするためのいくつかのパラメータを指定<br>
　/var/www/lizmap-web-client-$VERSION/lizmap/var/config/profiles.ini.php を編集<br>
Webminより編集<br>
　Tools　＞　FileManager　<br>
＞/var/www/lizmap-web-client-$VERSION/lizmap/var/config/profiles.ini.php<br>
　下記項目を置き換え<br>

[jdb:jauth]<br>
driver=pgsql<br>
host=localhost<br>
port=5432<br>
database="lizmap"<br>
user=postgres<br>
password=***<br>
search_path=public<br>

[jdb:lizlog]<br>
driver=pgsql<br>
host=localhost<br>
port=5432<br>
database="lizmap"<br>
user=postgres<br>
password=***<br>
search_path=public<br>

(step5)<br>
cd /var/www/lizmap-web-client-$VERSION/<br>
cd lizmap/var/config<br>
cp lizmapConfig.ini.php.dist lizmapConfig.ini.php<br>
cp localconfig.ini.php.dist localconfig.ini.php<br>
cd ../../..<br>
#インストールはpostgresの初期設定含む<br>
php lizmap/install/installer.php<br>

5-2.Lizmap Web Clientのadminパスワード変更<br>
http://lizmap.yamakun.net/lizmap/<br>
　 
  
接続　＞　ユーザー名，パスワード共に初期設定は「admin」<br>
 
![image018](https://user-images.githubusercontent.com/86514652/174402684-72d9f4d9-20f5-4cf1-b69c-146db9400c85.png)

管理　＞　ユーザー　＞　admin    表示　＞　パスワードを変更する　＞　保存<br>

 ![image019](https://user-images.githubusercontent.com/86514652/174402705-90fc60bb-b40f-4b1f-a859-f830117a8ed1.png)

5-3.Lizmap Web Clientの高速化（PHPのマルチスレッド化）<br>
(STEP１)<br>
sudo su<br>
apt -y install php-fpm<br>

vi /etc/apache2/sites-available/default-ssl.conf<br>
#バージョンはその都度確認の事　今回は8.0でした。<br>
# <VirtualHost> - </VirtualHost> 内に追記<br>
    <FilesMatch \.php$><br>
        SetHandler "proxy:unix:/var/run/php/php8.0-fpm.sock|fcgi://localhost/"<br>
    </FilesMatch><br>

a2enmod proxy_fcgi setenvif<br>
a2enconf php8.0-fpm<br>
systemctl restart php8.0-fpm apache2<br>

echo '<?php phpinfo(); ?>' > /var/www/html/lizmap/info.php<br>

<br>
https://lizmap.yamakun.net/info.php<br>

Server API[FPM/FastCGI] と表示されていれば OK です<br>
 
![image020](https://user-images.githubusercontent.com/86514652/174402814-5867b2f5-8e5a-463c-b38f-25fb838882e4.png)

（STEP2）<br>
ｐｈｐ-ｆｐｍの設定を行う<br>
 ![image021](https://user-images.githubusercontent.com/86514652/174402885-9083ab6c-91d4-4709-a81d-6af770155398.png)

 
をみると，pool.d/*.confに設定しろとある！<br>

　ｗｗｗ.ｃｏｎｆを確認すると，アカウント設定他いい感じに設定されている。<br>
　標準の　pm = dynamic　となっていたので，そのまま，下記を適切に設定！<br>
pm.max_children = 814<br>
pm.start_servers = 8<br>
pm.min_spare_servers = 4<br>
pm.max_spare_servers = 8<br>
pm.max_requests = 300<br>
![image022](https://user-images.githubusercontent.com/86514652/174402940-3afe36f6-e6ce-4ff0-95aa-36586fdacbe5.png)


動作確認は　htop　において　php-fpm　が複数起動し，きちんと動作していればＯＫ！<br>

（参考）問題なのは　qgis_mapserv.fcgi　のようです。<br>
 
  ![image023](https://user-images.githubusercontent.com/86514652/174403013-7ce10ae9-5627-4107-a257-59860b04cbec.png)

 
5-4.Lizmap Web Clientの高速化（QGIS Serverのマルチスレッド化）<br>
※QGISサーバーの設定　2. Apache2の設定（QGIS Server Plugin含む）に追加<br>
内容はレンダリングのマルチスレッド指定<br>

　・lizmap-fcgi.conf　へ追加　マルチスレッドを追加のみ<br>
　/etc/apache2/conf-available/lizmap-fcgi.conf <br>

#QGISのマルチスレッド化<br>
#並列レンダリングがアクティブ化されたときに使用するスレッドの数。<br>
#値が指定されている場合は、プロセッサ コアの数を使用します。‎-1<br>
FcgidInitialEnv QGIS_SERVER_MAX_THREADS 10<br>
#WMS GetMap 要求の並列レンダリングをアクティブにします。<br>
#デフォルトでは() は無効になっています。使用可能な値は次のとおりです。‎false<br>
#0‎または (大文字と小文字を区別しない)‎false<br>
#1‎または (大文字と小文字を区別しない)‎true<br>
FcgidInitialEnv QGIS_SERVER_PARALLEL_RENDERING 1<br>

結果は，下記の通りqgis_mapserv.fcgiがマルチスレッドで動くようになりました。<br>
![image024](https://user-images.githubusercontent.com/86514652/174403739-0e21bc57-cb01-4a43-9dc6-ba67b62637f9.png)

 
5-5.Lizmap Web Clientの高速化（py-qgis-serverの導入）　・・・　動きません，調査中<br>
sudo su<br>
#不要なものを削除<br>
sudo apt autoremove<br>
#システムを最新に<br>
apt -y upgrade<br>
#pipのインストール<br>
apt update<br>
apt -y uninstall python3-pip<br>
apt -y install python3-pip<br>
pip install --upgrade pip<br>
#zmq<br>
pip uninstall -y pyzmq<br>
pip install --no-cache-dir pyzmq<br>

#libzmq<br>
apt -y install libzmq3-dev<br>
#apt -y install libzmq5<br>

#py-qgis-serverのインストール<br>
#再インストールの場合は一度アンインストール<br>
pip uninstall -y py-qgis-server<br>
pip install --no-cache-dir py-qgis-server<br>

(STEP2)<br>
　・lizmap-fcgi.conf　へ設定を追加<br>
　/etc/apache2/conf-available/lizmap-fcgi.conf <br>

	[services]<br>
# wmsServerURL="http://my.domain:<port>/ows/"<br>
wmsServerURL="http://lizmap.yamakun.ner:8080/ows/"<br>
# Use relative path<br>
relativeWMSPath=true<br>

(STEP3)<br>
qgisserver<br>
