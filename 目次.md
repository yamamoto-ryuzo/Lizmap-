WebARENAにおけるLizmapの設定方法<br>
  2021-11-20<br>
目次<br>
※WebARENAの設定	2<br>
1.まずはWebARENAの申し込み	2<br>
2.VPSへの接続	2<br>
3.とりあえず最新版へ	3<br>
4.Ubuntuの環境設定（日本語フォント含む）	4<br>
5.毎日丑三つ時、午前2時に再起動の設定	5<br>
※WEB環境の構築	6<br>
1.Apache　サーバーの構築	6<br>
2.Webminをインストール	6<br>
3. Encrypt（SSL）導入	7<br>
4.Webminを利用	7<br>
5.ProFTPDの設定	9<br>
※QGISサーバーの設定	10<br>
1. QGISサーバーのインストール	10<br>
2. Apache2の設定（QGIS Server Plugin含む）	10<br>
※PostgreSQLデータベースの構築	12<br>
1.PostgreSQLデータベースのインストール	12<br>
2.postgresアカウントのパスワード設定	12<br>
3.lizmap追加アカウントの設定	12<br>
4.Lizmapデータベースの作成	13<br>
5.設定ファイルの編集	13<br>
6.PostGIS等拡張機能のインストール	14<br>

※Lizmap Web Clientの設定	15<br>
1.Lizmap Web Clientのソースコードのインストールと設定	15<br>
2.Lizmap Web Clientのadminパスワード変更	16<br>
3.Lizmap Web Clientの高速化（PHPのマルチスレッド化）	17<br>
4.Lizmap Web Clientの高速化（QGIS Serverのマルチスレッド化）	19<br>


 
※WebARENAの設定<br>
1.まずはWebARENAの申し込み<br>
・申し込みで口座確認のため1000円が一時的に落とされます<br>
・インスタンス作成，謎の220円が引落し，多分口座確認？<br>
![image001](https://user-images.githubusercontent.com/86514652/174294194-6052cb85-f572-4216-883e-97f59f8fd865.png)


2.VPSへの接続<br>
・SSH接続でインスタンスにログインする（Indigo）<br>
SSH接続でインスタンスにログインする（Indigo）<br>
SSH接続用クライアントソフト(Tera Term等)で、下記を指定し、インスタンスにSSH接続でログインします。<br>
・ホスト名：作成したインスタンスのIPアドレス<br>
・ユーザ名：centos または ubuntu<br>
・パスフレーズ：空白<br>
・ポート：22<br>
・鍵：SSH鍵の秘密鍵（private_key.txt）<br>
・インスタンスのIPアドレスの確認方法：<br>
[インスタンス管理]→[インスタンス]に移動し、作成したインスタンス名のIPアドレスの欄を確認してください。<br>
・ユーザ名：<br>
CentOSの場合、centos　　/　　Ubuntuの場合、ubuntu<br>
・SSH接続用クライアントソフト：Tera Term等<br>
ログイン後、下記のコマンドでroot権限に昇格します。<br>
sudo su -<br>
 
・起動画面はこんな感じ<br>
 ![image002](https://user-images.githubusercontent.com/86514652/174401447-66ddc3f9-7d8e-48c9-b849-8cd89082349a.png)


3.とりあえず最新版へ<br>
(step1)<br>
sudo apt-get update<br>
sudo apt-get upgrade<br>
必要に応じて[Y]を入力<br>
(step2)<br>
sudo apt dist-upgrade<br>
必要に応じて[Y]を入力<br>
(step3)<br>
sudo apt-get install update-manager-core<br>
(step4)<br>
sudo do-release-upgrade<br>
必要に応じて[Y]を入力<br>
 
4.Ubuntuの環境設定（日本語フォント含む）<br>
sudo su<br>
sudo apt autoremove<br>
sudo apt -y install language-pack-ja-base language-pack-ja<br>
sudo fc-cache -fv<br>
sudo apt -y install fonts-takao<br>
sudo fc-cache -fv<br>
sudo apt -y install fonts-ipafont fonts-ipaexfont<br>
sudo fc-cache -fv<br>
sudo apt -y install ttf-mscorefonts-installer<br>
sudo fc-cache -fv<br>
dpkg-reconfigure locales<br>
dpkg-reconfigure tzdata<br>
apt install ntp ntpdate<br>

　dpkg-reconfigure locales　下記確認，選択を求められます<br>
　1.ja_JP.UTF-8が選択されているかを確認<br>
 ![image003](https://user-images.githubusercontent.com/86514652/174401559-eca104fa-ef58-4a15-b240-f1d4af6b8046.png)
 
　2.ja_JP.UTF-8　を選択<br>
 ![image004](https://user-images.githubusercontent.com/86514652/174401570-49f16fd3-864d-476f-a4e5-88eabc228079.png)

dpkg-reconfigure tzdata<br>
apt install ntp ntpdate<br>
 
5.毎日丑三つ時、午前2時に再起動の設定<br>
sudo su<br>
crontab -e<br>
0 2 * * * /sbin/shutdown -r now<br>
 ![image005](https://user-images.githubusercontent.com/86514652/174401620-4af86ebe-c8f4-43f6-a4ed-218cc7fc1d26.png)

コマンドが追加されているので，#を改行してあげて綺麗に！<br>
あとは，エディタを　Ctrl+X　で終了し<br>
Yを選択し<br>
Enter　を押してファイル保存して終了<br>
 
※WEB環境の構築<br>
1.Apache　サーバーの構築<br>
（step1）<br>
sudo apt update<br>
sudo apt install apache2<br>
必要に応じて[Y]を入力<br>
sudo ufw app list<br>

（step2）Ubuntu20.04 ではPHP8.0を選択<br>
sudo add-apt-repository ppa:ondrej/php<br>
sudo apt update<br>
sudo apt install php8.0<br>
必要に応じて[Y]を入力<br>

（step3）<br>
sudo su<br>
apt search php8.0-*<br>
apt-get install php8.0-fpm php8.0-cli php8.0-bz2 php8.0-curl php8.0-gd php8.0-intl php8.0-mbstring php8.0-pgsql php8.0-sqlite3 php8.0-xml php8.0-ldap<br>
必要に応じて[Y]を入力<br>

（step4）php8.0-json を明示する必要があるよう<br>
sudo su<br>
apt-get install libapache2-mod-php8.0<br>

2.Webminをインストール<br>
（step1）<br>
sudo apt update<br>
sudo nano /etc/apt/sources.list<br>

（step2）<br>
下記をファイルに追加<br>
deb http://download.webmin.com/download/repository sarge contrib<br>

（step3）<br>
wget -q -O- http://www.webmin.com/jcameron-key.asc | sudo apt-key add<br>
sudo apt update<br>
sudo apt install webmin<br>
必要に応じて[Y]を入力<br>

（step4）ファイアウォールを設定<br>
sudo ufw allow 10000<br>
 
3. Encrypt（SSL）導入<br>
（SSLをインストール）<br>
sudo a2enmod ssl<br>
sudo a2ensite default-ssl<br>
sudo service apache2 restart<br>

（Install Certbot Snap）<br>
sudo snap install core<br>
sudo snap refresh core<br>
sudo apt -y remove certbot<br>
sudo snap install --classic certbot<br>
sudo ln -s /snap/bin/certbot /usr/bin/certbot<br>
（Install Certificates from Let's Encrypt）<br>
sudo certbot –apache<br>
（ドメイン入力）<br>
lizmap.yamakun.net　を入力<br>

4.Webminを利用<br>

https:// server-ip:10000/<br>
でアクセスすると安全ではないといわれるが無視！して接続する。<br>
 ![image006](https://user-images.githubusercontent.com/86514652/174401813-5b4ad211-2ab1-4c3e-8561-def64ac9dc9e.png)


そもそもrootパスワード設定した記憶がない・・・<br>

sudo su<br>
passwd<br>

でパスワードを設定<br>
Username:root　　Password：設定したパスワード<br>


ここまでくればあとは簡単！<br>
一応日本語化までを説明<br>
・「Change Language and Theme」をクリック<br>
 ![image007](https://user-images.githubusercontent.com/86514652/174401866-f894dd5f-7a7e-4603-aeaa-8b341c0fa5b2.png)

・「WebminConfiguration」＞「language and Locale」で「日本語」を選択<br>
 ![image008](https://user-images.githubusercontent.com/86514652/174401898-b4c0e7ba-6c11-4ecd-bef9-b44090cb1513.png)


完成です！<br>
システム時間を　「Asia/Tokyo」になっているかは再度確認。<br>
なっていないと，おや～～と思うことが発生します。<br>
 ![image009](https://user-images.githubusercontent.com/86514652/174401933-8c65d0f4-552d-4329-835b-71c0f68d8162.png)

 
5.ProFTPDの設定<br>

Webminよりインストール<br>
　未使用のモジュール　＞　ProFTPDサーバー　＞　InstallNow　　＞　InstallNow<br>

　 ![image010](https://user-images.githubusercontent.com/86514652/174402087-56c59192-f77b-4e48-a2f0-fb2fadd5e23c.png)


　サーバー　＞　ProFTPDサーバー　＞　各種設定が可能となっている<br>
 ![image011](https://user-images.githubusercontent.com/86514652/174402121-77a4c827-d239-46cd-92c9-3372b14e35f9.png)

ユーザーを作成<br>
　システム　＞　ユーザーおよびグループ<br>
　新しいユーザーを作成　＞　ユーザー名を「lizmapcloud」と入力<br>
　　　　　　　　　　　　　　ホームディレクトリ「/var/www/lizmap/lizmapcloud」<br>
　　　　　　　　　　　　　　パスワード「任意に入力」<br>
所属するグループ-既存グループから「www-data」を選択<br>
　　　　　　　　　　　　＞作成<br>

 
※QGISサーバーの設定<br>
1. QGISサーバーのインストール<br>
sudo apt -y install qgis-server<br>
sudo apt install -y apache2 libapache2-mod-fcgid<br>
sudo a2enmod cgid<br>
sudo systemctl restart apache2<br>

2. Apache2の設定（QGIS Server Plugin含む）<br>
・000-default.conf　，000-default-le-ssl.conf　の設定<br>
    Include conf-available/lizmap-fcgi.conf<br>
    Include conf-available/serve-cgi-bin.conf<br>
　を追加<br>
 ![image012](https://user-images.githubusercontent.com/86514652/174402261-b6a5f179-bbc3-4790-b402-1b85435ff2d1.png)

・lizmap-fcgi.conf　の作成<br>
　/etc/apache2/conf-available/lizmap-fcgi.conf <br>
FcgidInitialEnv SCRIPT_FILENAME /usr/lib/cgi-bin/qgis_mapserv.fcgi<br>
FcgidInitialEnv QGIS_PLUGINPATH /var/www/lizmap-web-client-3.4.6/lizmap/plugins<br>
(3.5以降？？　調査中)<br>
FcgidInitialEnv SCRIPT_FILENAME /usr/lib/cgi-bin/qgis_mapserv.fcgi<br>
FcgidInitialEnv QGIS_PLUGINPATH /usr/lib/qgis/plugins<br>

#QGISのマルチスレッド化<br>
#並列レンダリングがアクティブ化されたときに使用するスレッドの数。<br>
#値が指定されている場合は、プロセッサ コアの数を使用します。‎-1<br>
FcgidInitialEnv QGIS_SERVER_MAX_THREADS 10<br>
# WMS GetMap 要求の並列レンダリングをアクティブにします。<br>
#デフォルトでは() は無効になっています。使用可能な値は次のとおりです。‎false<br>
#  0‎または (大文字と小文字を区別しない)‎false<br>
#  1‎または (大文字と小文字を区別しない)‎true<br>
FcgidInitialEnv QGIS_SERVER_PARALLEL_RENDERING 1<br>

#FcgidInitialEnv QGIS_DEBUG 1<br>
#FcgidInitialEnv QGIS_AUTH_DB_DIR_PATH /opt/lizmap/data/qgis<br>
#FcgidInitialEnv QGIS_AUTH_PASSWORD_FILE /opt/lizmap/data/qgis/qgis-auth.db<br>
#FcgidInitialEnv PGPASSFILE /opt/lizmap/data/qgis/.pgpass<br>
#FcgidInitialEnv PGSERVICEFILE /opt/lizmap/data/qgis/.pg_service.conf<br>
#FcgidInitialEnv QGIS_SERVER_LOG_FILE /opt/lizmap/data/qgis/qgisserver.log<br>
#FcgidInitialEnv QGIS_SERVER_LOG_LEVEL 0 <br>
※PostgreSQLデータベースの構築<br>
1.PostgreSQLデータベースのインストール<br>
Webminよりインストール<br>
　未使用のモジュール　＞　PostgreSQLデータベースサーバー<br>
　＞　InstallNow　　＞　InstallNow<br>
2.postgresアカウントのパスワード設定<br>
Webminよりインストール<br>

　サーバー　＞　PostgreSQLデータベースサーバー　＞　PostgreSQLユーザー<br>
　＞　ユーザー名：postgresを選択　＞　パスワード設定　＞　保存<br>
3.lizmap追加アカウントの設定<br>
Webminより設定<br>

　サーバー　＞　PostgreSQLデータベースサーバー　＞　PostgreSQLユーザー<br>
　　　　　　＞　新規ユーザーを作成<br>
　＞　ユーザー名：lizmap，パスワード設定，データベースの作成を可能を選択<br>

 ![image013](https://user-images.githubusercontent.com/86514652/174402386-07d92c7a-2862-4c68-9e72-e52c793147db.png)

 ![image014](https://user-images.githubusercontent.com/86514652/174402420-495a3589-f06d-4c96-bbfa-35e9acbf1cbd.png)

4.Lizmapデータベースの作成<br>
Webminよりインストール<br>
　サーバー　＞　PostgreSQLデータベースサーバー　＞　新規データベースを作成<br>
　　　　　　＞　データベース名，オーナー：Lizmap　＞　作成<br>
 ![image015](https://user-images.githubusercontent.com/86514652/174402454-3fb0cb71-bca5-4680-8188-436b8c759552.png)

 
5.設定ファイルの編集<br>
　UBUNTU	/etc/postgresql/VERSION/main/postgresql.conf<br>
　に　listen_addresses = '*'　を追加<br>
 ![image016](https://user-images.githubusercontent.com/86514652/174402516-b79af190-0087-42fb-9b94-d0bf4539b5ba.png)
　
UBUNTU	/etc/postgresql/VERSION/main/pg_hba.conf　を下記に書き換え<br>

local	all all 							trust<br>
host	all all 127.0.0.1	255.255.255.255	md5<br>
host	all all 0.0.0.0/0					md5<br>
host	all all ::1/128						md5<br>
hostssl all all 127.0.0.1	255.255.255.255	md5<br>
hostssl all all 0.0.0.0/0					md5<br>
hostssl all all ::1/128						md5<br>
 
6.PostGIS等拡張機能のインストール<br>
pgAdminよりインストール<br>
　ログインは　postgres：スーパーユーザーで行う必要あり<br>
　拡張　を　右クリック　＞　作成　＞　拡張　＞「postgis」を選択　＞保存<br>
　　　　　　　　　　　　　　　　　　　　　　＞「pg_trgm」を選択　＞保存<br>
  　　　　　　　　　　　　　　　　　　　　　＞「unaccent」を選択　＞保存<br>

![image017](https://user-images.githubusercontent.com/86514652/174402540-0143fc31-e084-4edc-ae6b-be757b00ba1c.png)


※Lizmap Web Clientの設定<br>
1.Lizmap Web Clientのソースコードのインストールと設定<br>

・シンボリックリンクを http://localhost/lizmap/　に設定する<br>
・現在のバージョンは 3liz/lizmap-web-client: Transfer a QGIS project on a server, Lizmap is providing the web interface to browse it (github.com) で確認。<br>
2021/10/04　現在は　3.5.0<br>
(step1)<br>
sudo su<br>
cd /var/www/<br>
#unstalbe<br>
VERSION=3.5.1-pre<br>
wget https://packages.3liz.org/pub/lizmap/unstable/3.5/lizmap-web-client-3.5.1-pre.zip<br>
#VERSION=3.5.0<br>
#wget https://github.com/3liz/lizmap-web-client/releases/download/$VERSION/lizmap-web-client-$VERSION.zip<br>
unzip lizmap-web-client-$VERSION.zip<br>
rm /var/www/html/lizmap<br>
ln -s /var/www/lizmap-web-client-$VERSION/lizmap/www/ /var/www/html/lizmap<br>
rm lizmap-web-client-$VERSION.zip<br>
chown -R www-data:www-data /var/www/lizmap-web-client-$VERSION<br>

(step2)<br>
cd /var/www/lizmap-web-client-$VERSION/<br>
cd lizmap/var/config<br>
cp profiles.ini.php.dist profiles.ini.php<br>

(step4)<br>
・Postgresqlデータベースにアクセスするためのいくつかのパラメータを指定<br>
　/var/www/lizmap-web-client-$VERSION/lizmap/var/config/profiles.ini.php を編集<br>
Webminより編集<br>
　Tools　＞　FileManager　<br>
＞/var/www/lizmap-web-client-$VERSION/lizmap/var/config/profiles.ini.php<br>
　下記項目を置き換え<br>

[jdb:jauth]<br>
driver=pgsql<br>
host=localhost<br>
port=5432<br>
database="lizmap"<br>
user=postgres<br>
password=***<br>
search_path=public<br>

[jdb:lizlog]<br>
driver=pgsql<br>
host=localhost<br>
port=5432<br>
database="lizmap"<br>
user=postgres<br>
password=***<br>
search_path=public<br>

(step5)<br>
cd /var/www/lizmap-web-client-$VERSION/<br>
cd lizmap/var/config<br>
cp lizmapConfig.ini.php.dist lizmapConfig.ini.php<br>
cp localconfig.ini.php.dist localconfig.ini.php<br>
cd ../../..<br>
#インストールはpostgresの初期設定含む<br>
php lizmap/install/installer.php<br>
2.Lizmap Web Clientのadminパスワード変更<br>
http://lizmap.yamakun.net/lizmap/<br>
　 
  
接続　＞　ユーザー名，パスワード共に初期設定は「admin」<br>
 
![image018](https://user-images.githubusercontent.com/86514652/174402684-72d9f4d9-20f5-4cf1-b69c-146db9400c85.png)

管理　＞　ユーザー　＞　admin    表示　＞　パスワードを変更する　＞　保存<br>

 ![image019](https://user-images.githubusercontent.com/86514652/174402705-90fc60bb-b40f-4b1f-a859-f830117a8ed1.png)

3.Lizmap Web Clientの高速化（PHPのマルチスレッド化）<br>
(STEP１)<br>
sudo su<br>
apt -y install php-fpm<br>

vi /etc/apache2/sites-available/default-ssl.conf<br>
#バージョンはその都度確認の事　今回は8.0でした。<br>
# <VirtualHost> - </VirtualHost> 内に追記<br>
    <FilesMatch \.php$><br>
        SetHandler "proxy:unix:/var/run/php/php8.0-fpm.sock|fcgi://localhost/"<br>
    </FilesMatch><br>

a2enmod proxy_fcgi setenvif<br>
a2enconf php8.0-fpm<br>
systemctl restart php8.0-fpm apache2<br>

echo '<?php phpinfo(); ?>' > /var/www/html/lizmap/info.php<br>

<br>
https://lizmap.yamakun.net/info.php<br>

Server API[FPM/FastCGI] と表示されていれば OK です<br>
 
![image020](https://user-images.githubusercontent.com/86514652/174402814-5867b2f5-8e5a-463c-b38f-25fb838882e4.png)

（STEP2）<br>
ｐｈｐ-ｆｐｍの設定を行う<br>
 ![image021](https://user-images.githubusercontent.com/86514652/174402885-9083ab6c-91d4-4709-a81d-6af770155398.png)

 
をみると，pool.d/*.confに設定しろとある！<br>

　ｗｗｗ.ｃｏｎｆを確認すると，アカウント設定他いい感じに設定されている。<br>
　標準の　pm = dynamic　となっていたので，そのまま，下記を適切に設定！<br>
pm.max_children = 814<br>
pm.start_servers = 8<br>
pm.min_spare_servers = 4<br>
pm.max_spare_servers = 8<br>
pm.max_requests = 300<br>
![image022](https://user-images.githubusercontent.com/86514652/174402940-3afe36f6-e6ce-4ff0-95aa-36586fdacbe5.png)


動作確認は　htop　において　php-fpm　が複数起動し，きちんと動作していればＯＫ！<br>

（参考）問題なのは　qgis_mapserv.fcgi　のようです。<br>
 
  ![image023](https://user-images.githubusercontent.com/86514652/174403013-7ce10ae9-5627-4107-a257-59860b04cbec.png)

 
4.Lizmap Web Clientの高速化（QGIS Serverのマルチスレッド化）<br>
※QGISサーバーの設定　2. Apache2の設定（QGIS Server Plugin含む）に追加<br>
内容はレンダリングのマルチスレッド指定<br>

　・lizmap-fcgi.conf　へ追加　マルチスレッドを追加のみ<br>
　/etc/apache2/conf-available/lizmap-fcgi.conf <br>

#QGISのマルチスレッド化<br>
#並列レンダリングがアクティブ化されたときに使用するスレッドの数。<br>
#値が指定されている場合は、プロセッサ コアの数を使用します。‎-1<br>
FcgidInitialEnv QGIS_SERVER_MAX_THREADS 10<br>
#WMS GetMap 要求の並列レンダリングをアクティブにします。<br>
#デフォルトでは() は無効になっています。使用可能な値は次のとおりです。‎false<br>
#0‎または (大文字と小文字を区別しない)‎false<br>
#1‎または (大文字と小文字を区別しない)‎true<br>
FcgidInitialEnv QGIS_SERVER_PARALLEL_RENDERING 1<br>

結果は，下記の通りqgis_mapserv.fcgiがマルチスレッドで動くようになりました。<br>
![image024](https://user-images.githubusercontent.com/86514652/174403739-0e21bc57-cb01-4a43-9dc6-ba67b62637f9.png)

 
5.Lizmap Web Clientの高速化（py-qgis-serverの導入）　・・・　動きません，調査中<br>
sudo su<br>
#不要なものを削除<br>
sudo apt autoremove<br>
#システムを最新に<br>
apt -y upgrade<br>
#pipのインストール<br>
apt update<br>
apt -y uninstall python3-pip<br>
apt -y install python3-pip<br>
pip install --upgrade pip<br>
#zmq<br>
pip uninstall -y pyzmq<br>
pip install --no-cache-dir pyzmq<br>

#libzmq<br>
apt -y install libzmq3-dev<br>
#apt -y install libzmq5<br>

#py-qgis-serverのインストール<br>
#再インストールの場合は一度アンインストール<br>
pip uninstall -y py-qgis-server<br>
pip install --no-cache-dir py-qgis-server<br>

(STEP2)<br>
　・lizmap-fcgi.conf　へ設定を追加<br>
　/etc/apache2/conf-available/lizmap-fcgi.conf <br>

	[services]<br>
# wmsServerURL="http://my.domain:<port>/ows/"<br>
wmsServerURL="http://lizmap.yamakun.ner:8080/ows/"<br>
# Use relative path<br>
relativeWMSPath=true<br>

(STEP3)<br>
qgisserver<br>


